<!--
    TODO : remove the 'approved' class by default (it's just to show what it does, here).
    Add it only on questions which have been evaluated as 'improvable' or 'acceptable'.
    In addition of this class, questions should be 'locked' (uneditable).
    However, other questions ('to be fixed') don't get this special class and stay editable.
-->
<div class="pia-questionBlock" [ngClass]="{'approved': evaluation.status === 2 || evaluation.status === 3}" [attr.data-id]="question.id">
  <div class="pia-questionBlock-title">
    <button class="pia-icons pia-icon-accordeon-up" type="button" (click)="displayQuestion($event)" title="{{ 'misc.display' | translate }}"></button>
    {{ question.title | translate }}
  </div>
  <div class="pia-questionBlock-displayer fadeIn">
    <button type="button" class="btn pia-questionBlock-edit"
            *ngIf="displayEditButton && !_evaluationService.showValidationButton && !_evaluationService.enableFinalValidation"
            (click)="activateQuestionEdition()" title="{{ 'questions.edit' | translate }}">
      <i class="fa fa-pencil" aria-hidden="true"></i>
    </button>
    <form [formGroup]="questionForm">
      <div class="pia-gaugeBlock" *ngIf="question.answer_type == 'gauge'">
        <input type="range" (change)="checkGaugeChanges($event)" formControlName="gauge" min="0" max="4" step="1">
        <div>
          <div>{{ 'questions.gauges.undefined' | translate }}</div>
          <div>{{ 'questions.gauges.negligible' | translate }}</div>
          <div>{{ 'questions.gauges.limited' | translate }}</div>
          <div>{{ 'questions.gauges.important' | translate }}</div>
          <div>{{ 'questions.gauges.maximum' | translate }}</div>
        </div>
        <div class="pia-gaugeBlock-background"></div>
      </div>

      <div class="pia-questionBlock-content">
        <ng-container *ngIf="question.is_measure; else tagInput2">
          <tag-input
            *ngIf="question.answer_type == 'list'"
            (onAdd)="onAdd($event)"
            (onTagEdited)="onTagEdited($event)"
            (onRemove)="onRemove($event)"
            formControlName="list"
            [clearOnBlur]="true"
            [theme]="'foundation-theme'"
            [placeholder]="question.placeholder | translate"
            [editable]="false"
            [disabled]="_evaluationService.showValidationButton || _evaluationService.enableFinalValidation"
            [onlyFromAutocomplete]="true"
            (focusin)="questionContentFocusIn()"
            [secondaryPlaceholder]="question.placeholder | translate">
            <tag-input-dropdown
              [showDropdownIfEmpty]="true"
              [autocompleteItems]="userMeasures">
            </tag-input-dropdown>
          </tag-input>
        </ng-container>
        <ng-template #tagInput2>
          <tag-input
            *ngIf="question.answer_type == 'list'"
            (onAdd)="onAdd($event)"
            (onSelect)="onSelected($event)"
            (onTagEdited)="onTagEdited($event)"
            (onRemove)="onRemove($event)"
            [addOnBlur]="true"
            [separatorKeyCodes]="[27, 13]"
            formControlName="list"
            [theme]="'foundation-theme'"
            [placeholder]="question.placeholder | translate"
            [editable]="true"
            (focusin)="questionContentFocusIn()"
            [disabled]="_evaluationService.showValidationButton || _evaluationService.enableFinalValidation"
            [secondaryPlaceholder]="question.placeholder | translate">
          </tag-input>
        </ng-template>
        <div class="pia-questionBlock-contentText" [innerHTML]="questionForm.controls['text'].value | safeHtml" [ngClass]="{ 'hide': editor || !questionForm.controls['text'].value }"></div>
        <textarea
          *ngIf="question.answer_type == 'text' || question.answer_type == 'gauge'"
          [attr.data-id]="question.id"
          id="pia-question-content-{{question.id}}"
          formControlName="text"
          name="pia-question"
          minRows="8"
          cols="50"
          [ngClass]="{ 'hide': (!editor && questionForm.controls['text'].value) }"
          (focusin)="questionContentFocusIn()"
          placeholder="{{ question.placeholder | translate }}">
        </textarea>
      </div>
    </form>
  </div>

  <!-- TODO : to show only after a first edition (when the current question is created in DB) -->
  <app-comments [pia]="pia" [question]="question" [questionId]="question.id"></app-comments>

  <app-evaluations (evaluationEvent)="evaluationChange($event)"
                   *ngIf="item.evaluation_mode === 'question' && (_evaluationService.showValidationButton || _evaluationService.enableFinalValidation ||Â _evaluationService.someItemNeedToBeFixed)"
                   [pia]="pia" [section]="section" [item]="item" [questionId]="question.id"></app-evaluations>
</div>
